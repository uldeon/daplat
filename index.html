<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
  "http://www.w3.org/TR/html4/strict.dtd">
<html lang="fr">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>PaperRun ‚Äî Plateforme e-ink (SVG sprites)</title>
<style>
  html,body{height:100%;margin:0;padding:0;background:#fff;color:#000;font-family:Arial,Helvetica,sans-serif;-webkit-user-select:none;-moz-user-select:none;user-select:none;}
  #game{position:relative;margin:0 auto;overflow:hidden;border:1px solid #000;background:#fff}
  .tile{position:absolute;box-sizing:border-box;border:0}
  #hud{position:fixed;left:0;right:0;bottom:0;height:96px;display:block;padding:6px 8px;background:#fff;border-top:1px solid #000}
  .btn{display:inline-block;padding:14px 18px;margin-right:8px;border:1px solid #000;background:#fff;font-size:18px;touch-action:manipulation;-webkit-tap-highlight-color:rgba(0,0,0,0)}
  #info{position:fixed;left:8px;top:8px;background:#fff;padding:6px;border:1px solid #000;font-size:12px}
  #controls{position:fixed;right:8px;bottom:8px;display:flex;flex-direction:row;gap:8px}
  #controls .btn{padding:12px 16px;font-size:18px}
  #fps{position:fixed;right:8px;top:8px;background:#fff;padding:4px;border:1px solid #000;font-size:12px}
  /* classes monochromes */
  .solid{background:#000}
  /* reserve place pour svg player */
  #playerDiv{position:absolute;pointer-events:none}
  /* fallback coin style (rare) */
  .coin-fallback{background:#000;border-radius:50%}
</style>
</head>
<body>
<div id="info">PaperRun ‚Äî Plateforme optimis√©e e-ink (SVG)</div>
<div id="fps">FPS: --</div>
<div id="game"></div>

<div id="hud">
  <button id="btn-restart" class="btn">‚Ü∫ Restart</button>
  <button id="btn-save" class="btn">üíæ Save</button>
  <button id="btn-load" class="btn">üîÅ Load</button>
  <span style="margin-left:12px;font-size:14px">Score: <span id="score">0</span></span>
</div>

<div id="controls">
  <button id="left" class="btn">‚óÄ</button>
  <button id="jump" class="btn">‚ñ≤</button>
  <button id="right" class="btn">‚ñ∂</button>
</div>

<!-- Inline SVG sprite definitions (tr√®s simples, monochrome) -->
<svg id="sprites" width="0" height="0" style="position:absolute;left:-9999px;top:-9999px" aria-hidden="true" focusable="false">
  <defs>
    <!-- player: small rounded humanoid (rect + head) -->
    <g id="player-sprite" transform="scale(1)">
      <rect x="2" y="8" width="20" height="28" rx="2" ry="2" />
      <circle cx="12" cy="6" r="6" />
      <rect x="0" y="28" width="8" height="6" />
      <rect x="20" y="28" width="8" height="6" />
    </g>

    <!-- coin: circle with inner ring -->
    <g id="coin-sprite">
      <circle cx="10" cy="10" r="9" />
      <circle cx="10" cy="10" r="5" fill="#fff" />
    </g>

    <!-- block tile (solid) -->
    <g id="block-sprite"><rect x="0" y="0" width="32" height="32" /></g>

    <!-- platform: thinner rect -->
    <g id="platform-sprite"><rect x="0" y="10" width="32" height="12" rx="2" ry="2"/></g>
  </defs>
</svg>

<script>
/*
Version optimis√©e : r√©utilisation d'√©l√©ments DOM, pools, peu d'allocations,
√©viter fonctions anonymes multiples, approche imperative 'old-school'.
Les fonctionnalit√©s existantes sont pr√©serv√©es.
*/

// ===== CONFIG =====
var TILE = 18;
var VIEW_TILES_X = 34;
var VIEW_TILES_Y = 44;
var GRAVITY = 0.9;
var MOVE_SPEED = 1.8;
var JUMP_V = -8;
var DEFAULT_FPS = 6;
var HIGH_FPS = 12;
var TOUCH_FALLBACK_THRESHOLD = 800;

// ===== device detection =====
var deviceWidth = (window.innerWidth || document.documentElement.clientWidth);
var deviceHeight = (window.innerHeight || document.documentElement.clientHeight);
var lowPerf = (deviceWidth < TOUCH_FALLBACK_THRESHOLD) || (navigator.userAgent && navigator.userAgent.match(/Kindle|Silk|BowlDraw/i));
var FPS = lowPerf ? DEFAULT_FPS : HIGH_FPS;
if (deviceWidth < 600) TILE = 14;

// ===== DOM caching =====
var game = document.getElementById('game');
var scoreEl = document.getElementById('score');
var fpsEl = document.getElementById('fps');

// viewport sizing
var viewW = Math.floor(deviceWidth * 0.98);
var viewH = Math.floor(deviceHeight * 0.74);
game.style.width = viewW + 'px';
game.style.height = viewH + 'px';
var cols = Math.ceil(viewW / TILE);
var rows = Math.ceil(viewH / TILE);
cols = Math.max(20, Math.min(40, cols));
rows = Math.max(12, Math.min(60, rows));

// ===== LEVELS (identique) =====
var levels = [];
levels.push({
  name: "Tutoriel",
  map: [
    "                                    ",
    "                                    ",
    "                                    ",
    "                                    ",
    "                                    ",
    "           o          o             ",
    "       -----        -----           ",
    "                                    ",
    "    -----                 -----     ",
    "                                    ",
    "############################  #####"
  ],
  spawn: {x:2, y:7}
});
var curLevel = 0;
var map = levels[curLevel].map.slice();
var score = 0;

// ===== GAME STATE =====
var player = { x: levels[curLevel].spawn.x * TILE, y: levels[curLevel].spawn.y * TILE, w: Math.floor(TILE*0.9), h: Math.floor(TILE*1.4), vx:0, vy:0, grounded:false };
var keys = { left:false, right:false, jump:false };
var touchButtons = { left:false, right:false, jump:false };

// ===== Pools et √©l√©ments r√©utilisables =====
var divPool = [];
var svgPool = [];
var activeTiles = [];
var playerSvg = null;

// create an SVG element helper (reuse)
function makeSVG(name,w,h){
  // name is id in defs
  var ns = "http://www.w3.org/2000/svg";
  var s = document.createElementNS(ns,"svg");
  s.setAttribute("viewBox","0 0 32 32");
  s.setAttribute("width",w + "px");
  s.setAttribute("height",h + "px");
  s.style.position = "absolute";
  s.style.pointerEvents = "none";
  var use = document.createElementNS(ns,"use");
  // older browsers sometimes require xlink:href; try both
  try{ use.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href","#" + name); }catch(e){}
  use.setAttribute("href","#" + name);
  s.appendChild(use);
  return s;
}

// obtenir div pour tile solide
function getDiv(){
  var d = divPool.pop();
  if(!d){
    d = document.createElement('div');
    d.className = 'tile';
    game.appendChild(d);
  }
  return d;
}

// obtenir svg pour coin/other
function getSVG(){
  var s = svgPool.pop();
  if(!s){
    s = makeSVG('coin-sprite', Math.max(6, Math.floor(TILE*0.6)), Math.max(6, Math.floor(TILE*0.6)));
    game.appendChild(s);
  }
  return s;
}

function releaseAll(){
  for(var i=0;i<activeTiles.length;i++){
    var e = activeTiles[i];
    e.style.display = 'none';
    // return to right pool
    if(e.tagName && e.tagName.toLowerCase() === 'svg') svgPool.push(e);
    else divPool.push(e);
  }
  activeTiles.length = 0;
}

// ===== Simple tile helpers (kept) =====
function tileAt(col,row){
  if(row < 0 || row >= map.length) return '#';
  var line = map[row];
  if(col < 0 || col >= line.length) return ' ';
  return line.charAt(col);
}
function setTile(col,row,ch){
  if(row < 0 || row >= map.length) return;
  var line = map[row];
  if(col < 0 || col >= line.length) return;
  map[row] = line.substr(0,col) + ch + line.substr(col+1);
}

// ===== Render (optimis√©) =====
function render(){
  var cx = player.x + player.w/2;
  var cy = player.y + player.h/2;
  var viewCols = cols;
  var viewRows = rows;
  var startCol = Math.floor(cx / TILE) - Math.floor(viewCols/2);
  var startRow = Math.floor(cy / TILE) - Math.floor(viewRows/3);
  if(startCol < 0) startCol = 0;
  if(startRow < 0) startRow = 0;

  releaseAll();

  // render tiles
  for(var r=0;r<viewRows;r++){
    for(var c=0;c<viewCols;c++){
      var mc = startCol + c;
      var mr = startRow + r;
      var ch = tileAt(mc,mr);
      if(ch !== ' '){
        if(ch === '#' || ch === '-'){
          var d = getDiv();
          d.style.left = (c * TILE) + 'px';
          d.style.top = (r * TILE) + 'px';
          d.style.width = TILE + 'px';
          d.style.height = TILE + 'px';
          d.style.display = 'block';
          d.className = (ch === '#') ? 'tile solid' : 'tile solid';
          activeTiles.push(d);
        } else if(ch === 'o'){
          var s = getSVG();
          var coinSize = Math.max(6, Math.floor(TILE*0.6));
          s.setAttribute('width', coinSize + 'px');
          s.setAttribute('height', coinSize + 'px');
          s.style.left = (c * TILE + Math.floor(TILE*0.2)) + 'px';
          s.style.top = (r * TILE + Math.floor(TILE*0.2)) + 'px';
          s.style.display = 'block';
          activeTiles.push(s);
        }
      }
    }
  }

  // render player (SVG) on top
  if(!playerSvg){
    // create once
    playerSvg = makeSVG('player-sprite', player.w, player.h);
    playerSvg.id = 'playerDiv';
    playerSvg.style.zIndex = 999;
    game.appendChild(playerSvg);
  }
  var screenX = (player.x - startCol * TILE);
  var screenY = (player.y - startRow * TILE);
  playerSvg.style.left = Math.round(screenX) + 'px';
  playerSvg.style.top = Math.round(screenY) + 'px';
  playerSvg.style.width = player.w + 'px';
  playerSvg.style.height = player.h + 'px';

  // fps readout
  fpsEl.textContent = 'FPS: ' + FPS + (lowPerf ? ' (low)' : '');
}

// ===== Collision & physics (kept simple) =====
function collidesAt(x,y,w,h){
  var left = Math.floor(x / TILE);
  var right = Math.floor((x + w - 1) / TILE);
  var top = Math.floor(y / TILE);
  var bottom = Math.floor((y + h - 1) / TILE);
  for(var r=top;r<=bottom;r++){
    for(var c=left;c<=right;c++){
      var ch = tileAt(c,r);
      if(ch === '#' || ch === '-') return true;
    }
  }
  return false;
}
function collectAt(x,y,w,h){
  var left = Math.floor(x / TILE);
  var right = Math.floor((x + w - 1) / TILE);
  var top = Math.floor(y / TILE);
  var bottom = Math.floor((y + h - 1) / TILE);
  for(var r=top;r<=bottom;r++){
    for(var c=left;c<=right;c++){
      if(tileAt(c,r) === 'o'){
        setTile(c,r,' ');
        score += 10;
        scoreEl.textContent = score;
      }
    }
  }
}

// ===== Game loop =====
var accumulator = 0;
var lastTick = Date.now();
var tickInterval = 1000 / FPS;

function updatePhysics(){
  var move = 0;
  if(keys.left || touchButtons.left) move -= 1;
  if(keys.right || touchButtons.right) move += 1;
  player.vx = move * MOVE_SPEED;
  player.vy += GRAVITY;

  // horizontal
  var nx = player.x + player.vx;
  if(!collidesAt(nx, player.y, player.w, player.h)){
    player.x = nx;
  } else {
    player.vx = 0;
  }

  // vertical
  var ny = player.y + player.vy;
  if(!collidesAt(player.x, ny, player.w, player.h)){
    player.y = ny;
    player.grounded = false;
  } else {
    if(player.vy > 0){
      player.grounded = true;
      player.vy = 0;
      player.y = Math.floor(player.y / TILE) * TILE;
    } else {
      player.vy = 0;
    }
  }

  if((keys.jump || touchButtons.jump) && player.grounded){
    player.vy = JUMP_V;
    player.grounded = false;
  }

  collectAt(player.x, player.y, player.w, player.h);

  var maxY = map.length * TILE + TILE*6;
  if(player.y > maxY) respawn();
}

function gameTick(){
  var now = Date.now();
  var dt = now - lastTick;
  lastTick = now;
  accumulator += dt;

  var steps = 0;
  while(accumulator >= tickInterval && steps < 5){
    updatePhysics();
    accumulator -= tickInterval;
    steps++;
  }
  render();
}

function respawn(){
  player.x = levels[curLevel].spawn.x * TILE;
  player.y = levels[curLevel].spawn.y * TILE;
  player.vx = player.vy = 0;
}

function restartLevel(){
  map = levels[curLevel].map.slice();
  score = 0;
  scoreEl.textContent = score;
  respawn();
}

// ===== Controls (touch + mouse + keyboard) =====
function bindControls(){
  var L = document.getElementById('left');
  var R = document.getElementById('right');
  var J = document.getElementById('jump');

  L.addEventListener('touchstart', function(e){ e.preventDefault(); touchButtons.left=true; }, false);
  L.addEventListener('touchend', function(e){ e.preventDefault(); touchButtons.left=false; }, false);
  L.addEventListener('mousedown', function(){ touchButtons.left=true; }, false);
  L.addEventListener('mouseup', function(){ touchButtons.left=false; }, false);

  R.addEventListener('touchstart', function(e){ e.preventDefault(); touchButtons.right=true; }, false);
  R.addEventListener('touchend', function(e){ e.preventDefault(); touchButtons.right=false; }, false);
  R.addEventListener('mousedown', function(){ touchButtons.right=true; }, false);
  R.addEventListener('mouseup', function(){ touchButtons.right=false; }, false);

  J.addEventListener('touchstart', function(e){ e.preventDefault(); touchButtons.jump=true; }, false);
  J.addEventListener('touchend', function(e){ e.preventDefault(); touchButtons.jump=false; }, false);
  J.addEventListener('mousedown', function(){ touchButtons.jump=true; }, false);
  J.addEventListener('mouseup', function(){ touchButtons.jump=false; }, false);

  document.addEventListener('keydown', function(e){
    var kc = e.keyCode;
    if(kc === 37) keys.left = true;
    if(kc === 39) keys.right = true;
    if(kc === 38 || kc === 32) keys.jump = true;
  }, false);
  document.addEventListener('keyup', function(e){
    var kc = e.keyCode;
    if(kc === 37) keys.left = false;
    if(kc === 39) keys.right = false;
    if(kc === 38 || kc === 32) keys.jump = false;
  }, false);

  document.getElementById('btn-restart').addEventListener('click', restartLevel, false);
  document.getElementById('btn-save').addEventListener('click', saveState, false);
  document.getElementById('btn-load').addEventListener('click', loadState, false);
}

// ===== Save / Load (identique) =====
function saveState(){
  var st = { level: curLevel, player: {x:player.x,y:player.y}, score: score, map: map };
  try{
    localStorage.setItem('paperrun_save', JSON.stringify(st));
    alert('Saved.');
  }catch(e){
    alert('Impossible de sauvegarder (localStorage indisponible).');
  }
}
function loadState(){
  try{
    var raw = localStorage.getItem('paperrun_save');
    if(!raw) { alert('Aucune sauvegarde trouv√©e.'); return; }
    var st = JSON.parse(raw);
    curLevel = st.level || 0;
    map = st.map || map;
    player.x = (st.player && st.player.x) || player.x;
    player.y = (st.player && st.player.y) || player.y;
    score = st.score || 0;
    scoreEl.textContent = score;
    alert('Charg√©.');
  }catch(e){
    alert('Erreur lors du chargement.');
  }
}

// ===== Idle power saver (l√©ger, identique idea) =====
var idleCounter = 0;
setInterval(function(){
  var any = keys.left || keys.right || keys.jump || touchButtons.left || touchButtons.right || touchButtons.jump;
  if(!any){
    idleCounter++;
    if(idleCounter > 20 && !lowPerf){
      FPS = Math.max(2, Math.floor(FPS/2));
      tickInterval = 1000 / FPS;
    }
  } else {
    idleCounter = 0;
    FPS = lowPerf ? DEFAULT_FPS : HIGH_FPS;
    tickInterval = 1000 / FPS;
  }
}, 1000);

// ===== Init =====
bindControls();
restartLevel();
lastTick = Date.now();
setInterval(gameTick, 1000 / FPS);

// tiny polyfill: ensure SVG <use> works on older engines (best-effort)
(function(){
  var svg = document.getElementById('sprites');
  if(!svg) return;
  // nothing heavy here; fallback visuals are already provided via solid divs if browser fails
})();

</script>
</body>
</html>
