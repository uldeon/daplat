<!DOCTYPE html>
<html>
<head>
  <title>Platformer E-ink</title>
  <meta charset="utf-8">
</head>
<body style="margin:0; background:#fff;">

<!-- Onglets -->
<div style="text-align:center; margin:5px;">
  <button onclick="showGame()">Jeu</button>
  <button onclick="showEditor()">Éditeur</button>
</div>

<!-- Zone de jeu -->
<div id="gameTab">
  <svg id="game" width="600" height="300" style="background:#eee; display:block; margin:auto;">
    <!-- Sol -->
    <rect id="ground" x="0" y="260" width="600" height="40" fill="#444"/>
    <!-- Joueur -->
    <rect id="player" x="50" y="220" width="20" height="40" fill="#000"/>
    <!-- Ennemi -->
    <rect id="enemy" x="300" y="230" width="20" height="30" fill="#a00"/>
    <!-- Plateformes -->
    <g id="platforms"></g>
    <!-- Texte -->
    <text id="status" x="10" y="20" font-size="16" fill="#000">Score: 0</text>
  </svg>

  <!-- Contrôles tactiles -->
  <div style="text-align:center; margin-top:5px;">
    <button onclick="moveLeft()">⬅️</button>
    <button onclick="jump()">⬆️</button>
    <button onclick="moveRight()">➡️</button>
    <button onclick="crouch()">⬇️</button>
  </div>
  <div style="text-align:center; margin-top:5px;">
    <button onclick="resetGame()">Rejouer</button>
  </div>
</div>

<!-- Onglet éditeur -->
<div id="editorTab" style="display:none; text-align:center;">
  <p>Éditeur basique : ajoute des plateformes (x,y,w,h)</p>
  <input id="ex" size="3" placeholder="x"/>
  <input id="ey" size="3" placeholder="y"/>
  <input id="ew" size="3" placeholder="w"/>
  <input id="eh" size="3" placeholder="h"/>
  <button onclick="addPlatform()">Ajouter</button>
  <div>
    <textarea id="levelData" rows="6" cols="50"></textarea>
  </div>
  <button onclick="loadLevel()">Charger niveau</button>
</div>

<script type="text/javascript">
var player=document.getElementById("player");
var enemy=document.getElementById("enemy");
var status=document.getElementById("status");
var platformsGroup=document.getElementById("platforms");

var px, py, pw=20, ph=40, vx, vy, onGround, score, gameOver;
var platforms=[];

function init(){
  px=50; py=220; vx=0; vy=0;
  onGround=false; score=0; gameOver=false;
  player.setAttribute("x",px);
  player.setAttribute("y",py);
  player.setAttribute("height",ph);
  status.textContent="Score: 0";
  drawPlatforms();
  loop();
}
function resetGame(){ init(); }

function showGame(){document.getElementById("gameTab").style.display="block";document.getElementById("editorTab").style.display="none";}
function showEditor(){document.getElementById("gameTab").style.display="none";document.getElementById("editorTab").style.display="block";updateEditorText();}

document.onkeydown=function(e){
  if(gameOver) return;
  if(e.keyCode==37) vx=-2;
  if(e.keyCode==39) vx=2;
  if(e.keyCode==38 && onGround){vy=-6; onGround=false;}
  if(e.keyCode==40) crouch();
};
document.onkeyup=function(e){
  if(e.keyCode==37||e.keyCode==39) vx=0;
  if(e.keyCode==40) standUp();
};

function moveLeft(){vx=-2;}
function moveRight(){vx=2;}
function jump(){if(onGround){vy=-6; onGround=false;}}
function crouch(){if(ph==40){py+=20;ph=20;player.setAttribute("height",ph);player.setAttribute("y",py);}}
function standUp(){if(ph==20){py-=20;ph=40;player.setAttribute("height",ph);player.setAttribute("y",py);}}

function loop(){
  if(gameOver) return;
  vy+=0.3;
  py+=vy; px+=vx;

  // sol
  if(py+ph>=260){py=260-ph; vy=0; onGround=true;}

  // plateformes
  for(var i=0;i<platforms.length;i++){
    var p=platforms[i];
    if(px+pw>p.x && px<p.x+p.w && py+ph>=p.y && py+ph<=p.y+10 && vy>=0){
      py=p.y-ph; vy=0; onGround=true;
    }
  }

  // chute
  if(py>280){status.textContent="Game Over ! Score:"+score;gameOver=true;return;}

  // collision écran
  if(px<0) px=0;
  if(px>580) px=580;

  // ennemi
  var ex=parseInt(enemy.getAttribute("x"));
  ex+= (Math.sin(Date.now()/500))*1.5;
  enemy.setAttribute("x",ex);
  var ey=parseInt(enemy.getAttribute("y"));
  var ew=parseInt(enemy.getAttribute("width"));
  var eh=parseInt(enemy.getAttribute("height"));
  if(px<pw+ex && px+pw>ex && py<ey+eh && py+ph>ey){status.textContent="Touché ! Game Over. Score:"+score;gameOver=true;return;}

  score++;
  status.textContent="Score: "+score;
  player.setAttribute("x",px);
  player.setAttribute("y",py);

  setTimeout(loop,40);
}

// ----- Gestion plateformes -----
function drawPlatforms(){
  platformsGroup.innerHTML="";
  for(var i=0;i<platforms.length;i++){
    var p=platforms[i];
    var r=document.createElementNS("http://www.w3.org/2000/svg","rect");
    r.setAttribute("x",p.x);
    r.setAttribute("y",p.y);
    r.setAttribute("width",p.w);
    r.setAttribute("height",p.h);
    r.setAttribute("fill","#666");
    platformsGroup.appendChild(r);
  }
}
function addPlatform(){
  var x=parseInt(document.getElementById("ex").value);
  var y=parseInt(document.getElementById("ey").value);
  var w=parseInt(document.getElementById("ew").value);
  var h=parseInt(document.getElementById("eh").value);
  if(!isNaN(x)&&!isNaN(y)&&!isNaN(w)&&!isNaN(h)){
    platforms.push({x:x,y:y,w:w,h:h});
    updateEditorText();
  }
}
function updateEditorText(){
  document.getElementById("levelData").value=JSON.stringify(platforms);
}
function loadLevel(){
  var txt=document.getElementById("levelData").value;
  try{platforms=JSON.parse(txt);}catch(e){platforms=[];}
  drawPlatforms();
}
init();
</script>
</body>
</html>
